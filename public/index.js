import Icons from"./icons.js";import QR from"./qr.js";import Zip from"./zip.js";navigator.serviceWorker.register("sw.js",{type:"module"});let connections=[];const code=new URLSearchParams(window.location.search).get("code");const ws=new WebSocket("ws://localhost:3000");const usersWrap=document.getElementById("users");const blur=document.getElementById("blur");const createButton=document.querySelector("#create-wrap > button");const menu=document.getElementById("menu");let isFocused=false;let roomCode="";const updateCode=()=>{const text=menu.children[3].children[0].children[0];const qr=menu.children[2];text.classList.add("opacity-0");setTimeout((async()=>{text.innerText=`https://pindrop.zahtec.com/?code=${roomCode}`;qr.src=await QR.toDataURL(roomCode,{errorCorrectionLevel:"L",color:{light:"#303134",dark:"#fff"},type:"image/webp",width:350,margin:0});text.classList.remove("opacity-0");qr.classList.remove("opacity-0")}),300)};document.getElementById("copy").addEventListener("click",(()=>{if(!roomCode)return;navigator.clipboard.writeText(`https://pindrop.zahtec.com/?code=${roomCode}`)}));document.getElementById("leave").addEventListener("click",(()=>{menu.classList.remove("open");createButton.parentElement.classList.remove("open");setTimeout((()=>window.location.href="https://pindrop.zahtec.com"),300)}));createButton.addEventListener("click",(()=>{const has=menu.classList.contains("open");menu.children[4].tabIndex=has?-1:0;menu.children[3].children[1].tabIndex=has?-1:0;menu.children[5].tabIndex=has?-1:0;menu.classList.toggle("open");createButton.parentElement.classList.toggle("open");if(!roomCode)ws.send(JSON.stringify({type:"create"}))}));const focus=(user,fileName,type)=>{isFocused=true;user.classList.add(type,"z-40");user.children[0].tabIndex=-1;blur.classList.add("active");user.parentElement.classList.add("overflow-hidden");user.parentElement.scrollTo({top:user.offsetTop-user.clientHeight,behavior:"smooth"});const status=type==="focus-send";user.children[status?1:2].children[1].children[0].tabIndex=0;user.children[status?1:2].children[1].children[1].tabIndex=0;const name=user.children[status?1:2].children[0];name.innerText=name.innerText.replace("{FILE}",fileName)};const unFocus=(user,type)=>{isFocused=false;user.classList.remove(type);user.children[0].tabIndex=0;user.children[1].children[1].children[0].tabIndex=-1;user.children[1].children[1].children[1].tabIndex=-1;user.children[2].children[1].children[0].tabIndex=-1;user.children[2].children[1].children[1].tabIndex=-1;blur.classList.remove("active");user.parentElement.classList.remove("overflow-hidden");setTimeout((()=>{if(isFocused)return;user.classList.remove("z-40")}),500)};const startConnection=(id,ip)=>{if(connections.find((c=>c.id===id&&c.ip===ip)))return;ws.send(JSON.stringify({type:"verify",id:id,ip:ip}));return new Promise(((resolve,reject)=>{const verification=e=>{const msg=JSON.parse(e.data);if(!(msg.type==="verify"&&msg.id===id&&msg.ip===ip))return;if(!msg.status)reject();const newConnection=new Connection(msg.id,msg.ip);connections.push(newConnection);ws.removeEventListener("message",verification);newConnection.connectFrom(resolve)};ws.addEventListener("message",verification)}))};class Connection{rtc;dc;buffer;state;id;ip;constructor(id,ip){this.rtc=new RTCPeerConnection;this.state="offer";this.id=id;this.ip=ip;this.rtc.onicecandidate=()=>{if(this.rtc.iceGatheringState==="complete"){ws.send(JSON.stringify({type:this.state,data:this.rtc.localDescription,id:this.id,ip:this.ip}))}};this.rtc.ondatachannel=e=>{this.dc=e.channel;this.message()}}async connectFrom(func){this.dc=this.rtc.createDataChannel("data");this.message();this.dc.onopen=()=>{func(this.dc)};await this.getOffer()}async connectTo(offer){this.state="answer";await this.rtc.setRemoteDescription(offer);await this.getAnswer()}async getOffer(){await this.rtc.createOffer().then((offer=>this.rtc.setLocalDescription(offer)))}async getAnswer(){await this.rtc.createAnswer().then((answer=>this.rtc.setLocalDescription(answer)))}async setAnswer(answer){await this.rtc.setRemoteDescription(answer)}message(){let stage=0;let current=0;let info;const user=document.getElementById(`${this.ip}:${this.id}`);const fileSelect=user.querySelector("input");const progressBar=user.children[0].children[1].children[1];this.dc.onmessage=async({data:data})=>{if(!stage){const split=data.split(":");info=[split[0],Number.parseInt(split[1]),Number.parseInt(split[2])];progressBar.classList.remove("opacity-0");const name=user.children[0].children[2];name.innerText=name.innerText.split(".")[0].split("to ")[1];this.buffer=[];stage++}else{this.buffer.push(data);current+=data.byteLength;progressBar.style.setProperty("--percent",Math.round(current/info[2]*100).toString());if(stage===info[1]){this.download(info[0]);info=["",0,0];stage=0;current=0;fileSelect.disabled=false;fileSelect.value="";progressBar.classList.add("opacity-0");setTimeout((()=>progressBar.style.setProperty("--percent","0")),300);return}stage++}}}download(filename){const a=document.createElement("a");a.href=URL.createObjectURL(new Blob(this.buffer));a.download=filename;a.click();this.buffer=undefined}}const upload=(fileSelect,user,msg,f)=>{let file=fileSelect.files[0]??f?.item(0);const label=user.children[0];const progressBar=label.children[1].children[1];const name=label.children[2];const sendPopup=[user.children[1].children[0],user.children[1].children[1].children[0],user.children[1].children[1].children[1]];if(!file)return;sendPopup[0].innerText=`Are you sure you want to send "{FILE}" to ${msg.name}?`;focus(user,file.name,"focus-send");fileSelect.disabled=true;new Promise(((resolve,reject)=>{sendPopup[1].addEventListener("click",resolve,{once:true});sendPopup[2].addEventListener("click",reject,{once:true})})).then((async()=>{unFocus(user,"focus-send");label.classList.add("cursor-auto");label.tabIndex=-1;if(fileSelect.files&&fileSelect.files.length>1||f&&f.length>1){name.innerText="Zipping files...";progressBar.style.setProperty("--percent","50");progressBar.classList.remove("opacity-0");const zipFileWriter=new TransformStream;const zipPromise=new Response(zipFileWriter.readable).blob();const zipWriter=new Zip.ZipWriter(zipFileWriter);Array.from(fileSelect.files??f).forEach((async file=>await zipWriter.add(file.name,{readable:file.stream()})));await zipWriter.close();progressBar.style.setProperty("--percent","100");progressBar.classList.add("opacity-0");file=new File([await zipPromise],"pindrop-files.zip")}name.innerText=`Waiting for ${msg.name} to accept...`;ws.send(JSON.stringify({type:"confirm",id:msg.id,ip:msg.ip,file:file.name}));new Promise(((resolve,reject)=>{const confirmation=e=>{const message=JSON.parse(e.data);if(!(message.type==="confirm"&&message.id===msg.id&&message.ip===msg.ip))return;ws.removeEventListener("message",confirmation);if(!message.status)reject();else resolve(undefined)};ws.addEventListener("message",confirmation)})).then((async()=>{const existing=connections.find((c=>c.id===msg.id&&c.ip===msg.ip));name.innerText=`Connecting to ${msg.name}...`;const dc=existing?existing.dc:await startConnection(msg.id,msg.ip);if(!dc)return;name.innerText=msg.name;const chunks=Math.ceil(file.size/25e4);const reader=new FileReader;let chunk=0;async function*readChunks(){while(chunk<chunks){reader.readAsArrayBuffer(file.slice(chunk*25e4,(chunk+1)*25e4));await new Promise((resolve=>reader.onload=resolve));yield reader.result;chunk++}}const data=readChunks();const sender=async()=>{const chunkData=(await data.next()).value;if(!chunkData){dc.removeEventListener("bufferedamountlow",sender);fileSelect.disabled=false;fileSelect.value="";label.classList.remove("cursor-auto");label.tabIndex=0;progressBar.classList.add("opacity-0");setTimeout((()=>progressBar.style.setProperty("--percent","0")),300);return}progressBar.style.setProperty("--percent",Math.round(chunk/chunks*100).toString());dc.send(chunkData)};dc.send(`${file.name}:${chunks}:${file.size}`);dc.addEventListener("bufferedamountlow",sender);progressBar.classList.remove("opacity-0");sender()})).catch((()=>{name.innerText=`${msg.name} Declined`;fileSelect.value="";if(progressBar.style.getPropertyValue("--color")!=="#72eb54"){fileSelect.disabled=false;label.classList.remove("cursor-auto");label.tabIndex=0;setTimeout((()=>{name.innerText=msg.name}),1e3)}else{setTimeout((()=>{name.innerText=`${msg.name} is pending approval...`}),1e3)}}))})).catch((()=>{unFocus(user,"focus-send");label.classList.remove("cursor-auto");label.tabIndex=0;fileSelect.disabled=false;fileSelect.value=""}))};ws.onmessage=e=>{const msg=JSON.parse(e.data);switch(msg.type){case"init":{const name=document.getElementById("name");name.classList.add("opacity-0");setTimeout((()=>{name.innerText=`You are now discoverable as ${msg.name}`;name.classList.remove("opacity-0")}),300);if(code){if(!msg.cnid)window.history.replaceState({},"",window.location.origin);else{roomCode=code;updateCode()}}break}case"new-user":{usersWrap.insertAdjacentHTML("beforeend",`<div id="${msg.ip}:${msg.id}" class="h-40 w-full mb-10 md:mb-5 flex items-center md:items-start flex-col duration-500 transition-user opacity-0 translate-y-3 relative overflow-hidden">\n                    <label class="flex items-center flex-col md:flex-row cursor-pointer mt-2 md:ml-[33%]" tabindex="0">\n                        <input type="file" class="hidden" multiple>\n                        <div class="relative">\n                            <div class="bg-accent p-4 rounded-xl drop-shadow-lg w-min">\n                                ${Icons[msg.device]}\n                            </div>\n                            <div class="progress absolute opacity-0 transition-opacity duration-300 -top-2 -left-2 -right-2 -bottom-2 rounded-2xl -z-10"></div>\n                        </div>\n                        <h1 class="mt-4 text-center md:ml-6 md:mt-0">${msg.name}</h1>\n                    </label>\n                    <div class="text-center absolute md:justify-center md:flex md:flex-col md:h-full top-40 md:top-12 opacity-0 duration-500 transition-tropacity pointer-events-none md:ml-[33%]">\n                        <p>Are you sure you want to send "{FILE}" to ${msg.name}?</p>\n                        <div class="md:flex">\n                            <button class="flex justify-center items-center p-4 rounded-md bg-blue w-48 mt-8 mx-auto md:h-12 md:mt-4" tabindex="-1">Send</button>\n                            <button class="flex justify-center items-center p-4 rounded-md bg-accent w-48 mt-4 mx-auto md:h-12 md:ml-4" tabindex="-1">Cancel</button>\n                        </div>\n                    </div>\n                    <div class="text-center absolute md:justify-center md:flex md:flex-col md:h-full top-40 md:top-12 opacity-0 duration-500 transition-tropacity pointer-events-none md:ml-[33%]">\n                        <p>${msg.name} wants to send you "{FILE}"</p>\n                        <div class="md:flex">\n                            <button class="flex justify-center items-center p-4 rounded-md bg-blue w-48 mt-8 mx-auto md:h-12 md:mt-4" tabindex="-1">Accept</button>\n                            <button class="flex justify-center items-center p-4 rounded-md bg-accent w-48 mt-4 mx-auto md:h-12 md:ml-4" tabindex="-1">Decline</button>\n                        </div>\n                    </div>\n                </div>`);const user=document.getElementById(`${msg.ip}:${msg.id}`);const fileSelect=user.querySelector("input");const label=user.children[0];const progressBar=label.children[1].children[1];label.addEventListener("keydown",(e=>e.key==="Enter"?label.click():undefined));fileSelect.addEventListener("change",(()=>upload(fileSelect,user,msg)));user.addEventListener("dragover",(e=>e.preventDefault()));let bubble=0;user.addEventListener("dragenter",(()=>{e.preventDefault();bubble++;if(fileSelect.disabled||bubble>1)return;progressBar.classList.remove("opacity-0");progressBar.style.setProperty("--percent","100")}));user.addEventListener("dragleave",(()=>{e.preventDefault();bubble--;if(fileSelect.disabled||bubble)return;progressBar.classList.add("opacity-0");setTimeout((()=>{if(!progressBar.classList.contains("opacity-0"))return;progressBar.style.setProperty("--percent","0")}),300)}));user.addEventListener("drop",(e=>{e.preventDefault();bubble=0;if(fileSelect.disabled||!e.dataTransfer||!e.dataTransfer.files.length)return;progressBar.classList.add("opacity-0");progressBar.style.setProperty("--percent","0");upload(fileSelect,user,msg,e.dataTransfer.files)}));setTimeout((()=>{user.classList.remove("opacity-0");user.classList.remove("translate-y-3")}),1);break}case"del-user":{const connection=connections.find((c=>c.id===msg.id&&c.ip===msg.ip));if(connection){connection.rtc.close();connections=connections.filter((c=>c.id!==msg.id&&c.ip!==msg.ip))}const user=document.getElementById(`${msg.ip}:${msg.id}`);user.classList.add("h-0","mb-0","md:mb-0","opacity-0");if(user.classList.contains("focus-send")||user.classList.contains("focus-recieve"))blur.classList.remove("active");user.classList.remove("focus-send");user.parentElement.classList.remove("overflow-hidden");setTimeout((()=>{user.remove()}),500);break}case"offer":{if(connections.find((c=>c.id===msg.id&&c.ip===msg.ip)))return;const connection=new Connection(msg.id,msg.ip);connections.push(connection);connection.connectTo(msg.data);break}case"answer":{const connection=connections.find((c=>c.id===msg.id&&c.ip===msg.ip));if(!connection)return;connection.setAnswer(msg.data);break}case"confirm":{if(msg.status!==undefined)return;const user=document.getElementById(`${msg.ip}:${msg.id}`);const fileSelect=user.querySelector("input");const label=user.children[0];const name=label.children[2];const progressBar=label.children[1].children[1];const confirmPopup=[user.children[2].children[0],user.children[2].children[1].children[0],user.children[2].children[1].children[1]];confirmPopup[0].innerText=`${msg.name} wants to send you "{FILE}"`;new Promise(((resolve,reject)=>{if(user.classList.contains("focus-send")){new MutationObserver((()=>{if(user.classList.contains("focus-send"))return;if(fileSelect.files.length!==0)reject();else resolve(undefined)})).observe(user,{attributes:true})}else resolve(undefined)})).then((()=>{const revertAnimations=()=>{unFocus(user,"focus-receive");progressBar.style.setProperty("--percent","0");progressBar.style.setProperty("--color","#38acff");name.innerText=msg.name};fileSelect.disabled=true;label.classList.remove("cursor-auto");label.tabIndex=0;name.innerText=`${msg.name} is pending approval...`;progressBar.style.setProperty("--percent","100");progressBar.style.setProperty("--color","#72eb54");progressBar.classList.remove("opacity-0");setTimeout((()=>{user.addEventListener("click",(()=>{focus(user,msg.file,"focus-receive");new Promise(((resolve,reject)=>{confirmPopup[1].addEventListener("click",resolve,{once:true});confirmPopup[2].addEventListener("click",reject,{once:true})})).then((()=>{revertAnimations();label.classList.add("cursor-auto");label.tabIndex=-1;name.innerText=`Connecting to ${msg.name}...`;ws.send(JSON.stringify({type:"confirm",status:1,id:msg.id,ip:msg.ip}))})).catch((()=>{revertAnimations();fileSelect.disabled=false;ws.send(JSON.stringify({type:"confirm",status:0,id:msg.id,ip:msg.ip}))}))}),{once:true})}),1)})).catch((()=>ws.send(JSON.stringify({type:"confirm",status:0,id:msg.id,ip:msg.ip}))));break}case"create":{roomCode=msg.ip;window.history.replaceState({},"",`${window.location.origin}/?code=${roomCode}`);updateCode()}}};ws.onopen=()=>ws.send(JSON.stringify({type:"init",cnid:code}));ws.onerror=()=>{createButton.disabled=true;const name=document.getElementById("name");name.classList.add("opacity-0");setTimeout((()=>{name.innerText="You are offline, please connect to the internet";name.classList.remove("opacity-0")}),300)};